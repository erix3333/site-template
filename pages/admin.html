<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin — Catalog</title>
  <link rel="stylesheet" href="../styles.css" />
  <style>
    .admin-wrap{ max-width: 1200px; margin: 24px auto; padding: 0 12px; }
    .toolbar{ display:flex; gap:8px; flex-wrap:wrap; margin-bottom:12px }
    table{ width:100%; border-collapse: collapse; border:1px solid var(--line); }
    th, td{ border-top:1px solid var(--line); padding:8px; vertical-align: top; }
    th{ text-align:left; background:#fafafa }
    input[type="text"], input[type="number"]{ width:100%; padding:8px 10px; border:1px solid var(--line); border-radius:10px; }
    .ok{ color: #0a0 }
    .bad{ color: #a00 }
    .muted.small{ font-size:12px }
    .footer{ margin-top:16px; display:flex; justify-content:space-between; align-items:center; }
  </style>
</head>
<body>
  <header class="site-header">
    <div class="wrap header-inner">
      <a class="brand" href="../index.html"><img id="brandLogo" src="../images/logo.png" alt="" /><span id="brandName">Shop Name</span></a>
      <div class="toolbar">
        <a class="btn" href="../index.html#products">Back to store</a>
      </div>
    </div>
  </header>

  <main class="admin-wrap">
    <h1>Catalog Admin</h1>
    <p class="muted">Load current catalog, edit rows, then <b>Validate</b> and <b>Save</b>.</p>

    <div class="toolbar">
      <button class="btn" id="loadBtn">Load</button>
      <button class="btn" id="addBtn">Add row</button>
      <button class="btn" id="validateBtn">Validate</button>
      <button class="btn primary" id="saveBtn">Save</button>
      <button class="btn" id="exportBtn">Export JSON</button>
    </div>

    <table id="grid">
      <thead>
        <tr>
          <th style="width:130px">id</th>
          <th>title</th>
          <th style="width:110px">price (EUR)</th>
          <th>image URL</th>
          <th>category</th>
          <th>excerpt</th>
          <th>description</th>
          <th style="width:140px">stripePrice (opt.)</th>
          <th style="width:40px">×</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="footer">
      <div id="status" class="muted small">Idle.</div>
    </div>
  </main>

  <script>
    const $ = (s,el=document)=>el.querySelector(s);
    const $$ = (s,el=document)=>Array.from(el.querySelectorAll(s));

    const tbody = $('#grid tbody');
    const statusEl = $('#status');

    function setStatus(msg, good=false){
      statusEl.textContent = msg;
      statusEl.className = 'muted small ' + (good ? 'ok' : '');
    }

    function addRow(p = { id:'', title:'', price:0, image:'', category:'', excerpt:'', description:'', stripePrice:'' }){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input type="text" name="id" value="${escapeHtml(p.id||'')}" /></td>
        <td><input type="text" name="title" value="${escapeHtml(p.title||'')}" /></td>
        <td><input type="number" step="0.01" name="price" value="${Number(p.price||0)}" /></td>
        <td><input type="text" name="image" value="${escapeHtml(p.image||'')}" /></td>
        <td><input type="text" name="category" value="${escapeHtml(p.category||'')}" /></td>
        <td><input type="text" name="excerpt" value="${escapeHtml(p.excerpt||'')}" /></td>
        <td><input type="text" name="description" value="${escapeHtml(p.description||'')}" /></td>
        <td><input type="text" name="stripePrice" value="${escapeHtml(p.stripePrice||'')}" /></td>
        <td><button class="btn" data-del>Del</button></td>
      `;
      tr.querySelector('[data-del]').addEventListener('click', ()=> tr.remove());
      tbody.appendChild(tr);
    }

    function getData(){
      return $$('#grid tbody tr').map(tr=>{
        const o = {};
        $$('input', tr).forEach(inp => o[inp.name] = inp.type==='number' ? Number(inp.value||0) : (inp.value||''));
        return o;
      });
    }

    function validate(list){
      for (const p of list){
        if (!p.id || !p.title) return { ok:false, msg:'Each row needs id and title.' };
        if (typeof p.price !== 'number' || isNaN(p.price)) return { ok:false, msg:`Invalid price for ${p.id}` };
      }
      return { ok:true, msg: `Looks good. ${list.length} product(s).` };
    }

    function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]) ); }

    // ---- Buttons ----
    $('#loadBtn').addEventListener('click', async ()=>{
      setStatus('Loading…');
      try{
        const r = await fetch('/api/catalog', { cache:'no-store' });
        if (!r.ok) throw new Error(r.status);
        const data = await r.json();
        tbody.innerHTML = '';
        (data||[]).forEach(addRow);
        setStatus('Loaded.', true);
      }catch(e){ setStatus('Load failed: ' + e.message); }
    });

    $('#addBtn').addEventListener('click', ()=> addRow());

    $('#validateBtn').addEventListener('click', ()=>{
      const check = validate(getData());
      setStatus(check.msg, check.ok);
      if (!check.ok) alert(check.msg);
    });

    $('#saveBtn').addEventListener('click', async ()=>{
      const list = getData();
      const check = validate(list);
      if (!check.ok){ alert(check.msg); return; }
      const key = prompt('Enter ADMIN_KEY to save:');
      if (!key){ alert('Canceled'); return; }
      setStatus('Saving…');
      try{
        const r = await fetch('/api/catalog', {
          method:'PUT',
          headers: { 'Content-Type':'application/json', 'x-admin-key': key },
          body: JSON.stringify(list)
        });
        const j = await r.json();
        if (!r.ok) throw new Error(j.error || r.status);
        setStatus('Saved to Blob storage.', true);
        alert('Saved successfully.');
      }catch(e){ setStatus('Save failed: ' + e.message); }
    });

    $('#exportBtn').addEventListener('click', ()=>{
      const data = JSON.stringify(getData(), null, 2);
      const blob = new Blob([data], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'products.json';
      a.click();
      URL.revokeObjectURL(a.href);
    });

    // Auto-load on open
    document.addEventListener('DOMContentLoaded', ()=> $('#loadBtn').click());
  </script>
</body>
</html>
